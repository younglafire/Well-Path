{% for goal in goals %}
  <div class="goal-card mb-4">
    <div class="goal-card">
      <div class="goal-card-header">
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div class="d-flex align-items-center">
            <div class="bg-primary-100 rounded-circle p-2 me-3">
              <i data-lucide="user" style="width: 20px; height: 20px; color: var(--primary-600);"></i>
            </div>
            <span class="fw-medium text-muted">{{ goal.user.username }}</span>
          </div>
          <span class="status-badge status-{% if goal.progress_percent >= 100 %}completed{% elif goal.days_remaining <= 0 %}overdue{% else %}active{% endif %}">
            {% if goal.progress_percent >= 100 %}Completed{% elif goal.days_remaining <= 0 %}Overdue{% else %}Active{% endif %}
          </span>
        </div>
        <div class="goal-title">
          <a href="{% if user.is_authenticated %}
                      {% url 'goal_detail' goal.id %}
                  {% else %}
                      {% url 'login' %}?next={% url 'goal_detail' goal.id %}
                  {% endif %}" class="text-decoration-none">
            {{ goal.title }}
          </a>
        </div>
      </div>
      <div class="goal-card-body">
        <p class="goal-description">{{ goal.description|truncatewords:15 }}</p>
        <!-- Goal Stats -->
        <div class="goal-stats">
          <div class="goal-stat">
            <span class="goal-stat-value">{{ goal.total_progress|floatformat:1 }}</span>
            <span class="goal-stat-label">Current</span>
          </div>
          <div class="goal-stat">
            <span class="goal-stat-value">{{ goal.target_value|floatformat:0 }}</span>
            <span class="goal-stat-label">Target</span>
          </div>
        </div>

        <!-- Progress Bar -->
        <div class="modern-progress">
          <div class="modern-progress-bar"
               style="width: {% if goal.progress_percent > 0 %}{{ goal.progress_percent|floatformat:0 }}{% else %}2{% endif %}%;"></div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center text-sm">
          <span class="fw-medium">{{ goal.progress_percent|floatformat:0 }}% Complete</span>
          <span class="text-muted">{{ goal.total_progress|floatformat:1 }}/{{ goal.target_value }} {{ goal.unit.name }}</span>
        </div>

      {% if show_progress_form %}
        <div class="mt-4">
        {% if not goal.is_completed and not goal.is_overdue %}
          {% if not goal.today_progress %}
          <form method="POST" action="{% url 'add_progress' %}" class="d-flex gap-2 goal-progress-form">
            {% csrf_token %}
            <input type="number" class="modern-form-control flex-grow-1" name="progress"
                   placeholder="Today's progress" min="0" step="0.1" required>
            <input type="hidden" name="goal_id" value="{{ goal.id }}">
            <button type="submit" class="btn btn-success-modern">
              <i data-lucide="plus" class="me-1"></i>Add
            </button>
          </form>
          {% else %}
          <div class="d-flex align-items-center justify-content-center p-3 bg-success-50 rounded">
            <i data-lucide="check-circle" class="me-2" style="color: var(--success-600);"></i>
            <span class="text-success-600 fw-medium">
              {{ goal.today_progress.value|default:0|floatformat:1 }} {{ goal.unit.name }} completed today!
            </span>
          </div>
          {% endif %}
          {% elif goal.is_completed %}
          <div class="d-flex align-items-center justify-content-center p-3 bg-success-50 rounded">
            <i data-lucide="check-circle" class="me-2" style="color: var(--success-600);"></i>
          </div>
          {% elif goal.is_overdue %}
          <div class="d-flex align-items-center justify-content-center p-3 bg-danger-50 rounded">
            <i data-lucide="alert-circle" class="me-2" style="color: var(--danger-600);"></i>
            <span class="text-danger-600 fw-medium">
              This goal is overdue!
            </span>
          </div>
          {% endif %}
        </div>
      {% endif %}

<!-- Likes, comments section -->
<div class="goal-actions d-flex justify-content-between mt-3">
  <button 
      class="btn btn-sm btn-outline-primary like-btn" 
      data-goal-id="{{ goal.id }}" 
      data-like-url="{% url 'like_goal' goal.id %}">
    ‚ù§Ô∏è <span class="like-count">{{ goal.likes_count }}</span>
  </button>

  <button 
      class="btn btn-sm btn-outline-secondary comment-btn" 
      data-goal-id="{{ goal.id }}"
      data-comments-url="{% url 'comment_goal' goal.id %}">
    üí¨ <span class="comment-count">{{ goal.comments_count }}</span>
  </button>
</div>

<!-- Comments Section -->
<div class="comments-container mt-3" id="comments-{{ goal.id }}" style="display: none;">
  <!-- Existing comments will be loaded here via JS -->
  <div class="comment-list"></div>

  <!-- Add comment form -->
  {% if user.is_authenticated %}
  <form 
      class="comment-form d-flex mt-2" 
      data-goal-id="{{ goal.id }}"
      data-comments-url="{% url 'comment_goal' goal.id %}">
    <input type="text" class="form-control form-control-sm me-2 comment-input" 
          placeholder="Write a comment..." required>
    <button type="submit" class="btn btn-sm btn-primary">Post</button>
  </form>
  {% else %}
  <p class="text-muted small">Login to comment</p>
  {% endif %}
</div>

      <div class="goal-card-footer">
        <div class="d-flex align-items-center text-muted">
          <i data-lucide="calendar" class="me-1" style="width: 16px; height: 16px;"></i>
          <small>{{ goal.deadline|default:"No deadline" }}</small>
        </div>
        {% if not goal.is_completed and not goal.is_overdue %}
        <div class="d-flex align-items-center text-muted">
          <i data-lucide="clock" class="me-1" style="width: 16px; height: 16px;"></i>
          <small>{{ goal.days_remaining }} days left</small>
        </div>
        
        {% elif goal.is_completed and goal.finished_at %}
        <div class="d-flex align-items-center text-muted">
          <i data-lucide="clock" class="me-1" style="width: 16px; height: 16px;"></i>
          <small>Completed on {{ goal.finished_at|date:"F j, Y" }}</small>
        </div>
        {% elif goal.is_overdue and goal.progress_percent < 100 %}
        <div class="d-flex align-items-center text-danger">
          <i data-lucide="alert-circle" class="me-1" style="width: 16px; height: 16px;"></i>
          <small class="fw-medium">{{ goal.days_remaining|add:"-1" }} days overdue</small>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
{% empty %}
  <div class="modern-card text-center">
    <div class="modern-card-body py-5">
      <i data-lucide="target" style="width: 64px; height: 64px; color: var(--neutral-400);" class="mb-4"></i>
      <h4 class="text-muted">No goals found</h4>
      <p class="text-muted mb-4">Start your journey by creating your next goal!</p>
      {% if user.is_authenticated %}
      <a href="{% url 'create_goal' %}" class="btn btn-primary-modern">
        <i data-lucide="plus" class="me-2"></i>Create Your Next Goal
      </a>
      {% else %}
      <a href="{% url 'register' %}" class="btn btn-primary-modern">
        <i data-lucide="user-plus" class="me-2"></i>Get Started
      </a>
      {% endif %}
    </div>
  </div>
{% endfor %}